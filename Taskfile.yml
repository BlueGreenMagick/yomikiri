version: '3'

includes:
  main:
    taskfile: './main/Taskfile.yml'
    dir: './main'
  japanese-utils:
    taskfile: './crates/japanese-utils/Taskfile.yml'
    dir: './crates/japanese-utils'
  jmdict:
    taskfile: './crates/jmdict/Taskfile.yml'
    dir: './crates/jmdict'
  unidic:
    taskfile: './crates/unidic/Taskfile.yml'
    dir: './crates/unidic'
  unidic-types:
    taskfile: './crates/unidic-types/Taskfile.yml'
    dir: './crates/unidic-types'
  yomikiri-backend:
    aliases: [backend]
    taskfile: './crates/yomikiri-backend/Taskfile.yml'
    dir: './crates/yomikiri-backend'
  yomikiri-dictionary:
    taskfile: './crates/yomikiri-dictionary/Taskfile.yml'
    dir: './crates/yomikiri-dictionary'
  yomikiri-dictionary-generator:
    taskfile: './crates/yomikiri-dictionary-generator/Taskfile.yml'
    dir: './crates/yomikiri-dictionary-generator'
  generate-license:
    taskfile: './extra/generate-license/Taskfile.yml'
    dir: './extra/generate-license'

vars:
  # All Taskfiles should have 'check', 'lint', 'test' commands
  INCLUDES:
    - main
    - japanese-utils
    - jmdict
    - unidic
    - unidic-types
    - yomikiri-backend
    - yomikiri-dictionary
    - yomikiri-dictionary-generator
    - generate-license

tasks:
  print-version:
    desc: Print version in root package.json
    cmds:
      - tsx './extra/scripts/print-version.ts'

  check:
    desc: Check files
    cmds:
      - for: { var: INCLUDES }
        task: '{{.ITEM}}:check'

  lint:
    desc: Lint files
    cmds:
      - for: { var: INCLUDES }
        task: '{{.ITEM}}:lint'

  test:
    desc: Test files
    cmds:
      - for: { var: INCLUDES }
        task: '{{.ITEM}}:test'

  format:
    aliases: ['fmt']
    desc: 'Format all files'
    deps: ['format:prettier', 'format:rust']

  format:prettier:
    aliases: ['fmt:prettier']
    desc: 'Format files using prettier'
    cmds:
      - 'pnpm prettier --write --list-different .'

  format:rust:
    aliases: ['fmt:rust']
    desc: 'Format files using Cargo (Rust)'
    cmds:
      - 'cargo fmt'

  check-format:prettier:
    aliases: ['check-fmt:prettier']
    cmds:
      - pnpm prettier --check .

  check-format:rust:
    aliases: ['check-fmt:rust']
    cmds:
      - cargo fmt --check

  check-format:
    aliases: ['check-fmt']
    desc: 'Check if files are formatted'
    deps: [check-format:js, check-format:rust]

  build:all:
    run: once
    cmds:
      - task: 'build:chrome'
      - task: 'build:firefox'
      - task: 'build:ios'

  build:chrome:
    run: once
    deps:
      - task: 'backend:generate:wasm'
        vars:
          RELEASE: '1'
      - 'generate-license:generate'
    cmds:
      - task: 'main:build:firefox'

  build:firefox:
    run: once
    deps:
      - task: 'backend:generate:wasm'
        vars:
          RELEASE: '1'
      - 'generate-license:generate'
    cmds:
      - task: 'main:build:firefox'

  build:ios:
    run: once
    deps:
      - task: 'backend:generate:ios'
        vars:
          RELEASE: '1'
      - 'generate-license:generate'
    cmds:
      - task: 'main:build:ios'
      - task: 'main:build:iosapp'

  dev:chrome:
    aliases: ['dev']
    run: once
    deps:
      - task: 'backend:generate:wasm'
        vars:
          RELEASE: ''
    cmds:
      - task: 'main:dev:firefox'

  dev:firefox:
    run: once
    deps:
      - task: 'backend:generate:wasm'
        vars:
          RELEASE: ''
    cmds:
      - task: 'main:dev:firefox'
